ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°
ì´ì¬ì„± | ê³ ì–¸ì–´ë¡œ API Gateway + Lambda ì‰½ê²Œ ì“°ê¸°

* ëª©ì°¨
- ë°œí‘œ ì£¼ì œ ì†Œê°œ
- Golang Lambda ë°°í¬ ì‹¤ìŠµ
- Golang API Gateway + Lambda ì‹¤ìŠµ
- Golang API Gateway + Lambda ë¼ìš°íŒ…, ë¬¸ì œì  íŒŒì•…, ë¬¸ì œ í•´ê²° ì—¬ì •
- *httplam*, *echolam* ì†Œê°œ

* ë°œí‘œ ì£¼ì œ ì†Œê°œ

* ì™œ? API Gateway + Lambdaë¥¼ ì„ íƒí–ˆëŠ”ê°€
*!!!!!!MONEY!!!!!*
.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/img_money.jpeg 400 566

* API Gateway Pricing

*í”„ë¦¬í‹°ì–´* *ê¸°ê°„*
ë§¤ì›” ë¬´ë£Œ

- ìˆ˜ì‹  API í˜¸ì¶œ 100ë§Œ ê°œ
- ìˆ˜ì‹  HTTP í˜¸ì¶œ 100ë§Œ ê°œ
- ë©”ì‹œì§€ 100ë§Œ ê°œ
- ì—°ê²° ì‹œê°„ 750,000ë¶„

*ë¹„ìš©*

.html ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/tbl_apigw_pricing.html

* Lambda Pricing
*í‰ìƒ*
ë§¤ì›” ë¬´ë£Œ

- ìš”ì²­ 100ë§Œ ê±´

*ë¹„ìš©*
.html ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/tbl_lambda_pricing.html


* ê¸°ì¡´ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜

# .image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/app_arch_typ1.png 500 554
.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/app_arch_typ2.png 500 580

* ê¸°ì¡´ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì³ì˜ ë¬¸ì œì 
- ìƒˆë¡œìš´ ê¸°ëŠ¥(í”¼ì³)ë¥¼ ì¶”ê°€í•˜ëŠ” ë° ë¶ˆí¸í•¨
- ë°°í¬ í¬ì¸íŠ¸ê°€ ëŠ˜ì–´ë‚¨
- ì¶”í›„ ì„œë²„ë¦¬ìŠ¤ë¥¼ íƒˆí”¼ í•˜ê¸°í˜ë“¦(ë²¤ë”ë½)

* ì–´ë–»ê²Œ í•´ê²°í•´ì•¼ í• ê¹Œ?

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/ê³ ë¯¼_ì•„í•˜ì–´ë¦°ì´.jpg 500 578

* í•´ê²° ë°©ë²•
- í•˜ë‚˜ì˜ ëŒë‹¤ë¡œë§Œ ê´€ë¦¬í•˜ë©´?

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/ì•„í•˜_ì•„í•˜ì–´ë¦°ì´.jpg 400 400

* ìƒˆë¡œìš´ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/app_new_arch.png 112 500

* Golang Lambda ì‹¤ìŠµ

* ê³ ì–¸ì–´, ëŒë‹¤ Get Started

[[https://github.com/aws/aws-lambda-go#getting-started][Reference]]

    // main.go
    package main

    import (
        "github.com/aws/aws-lambda-go/lambda"
    )

    func hello() (string, error) {
        return "Hello Î»!", nil
    }

    func main() {
        // Make the handler available for Remote Procedure Call by AWS Lambda
        lambda.Start(hello)
    }



* ê³ ì–¸ì–´ ëŒë‹¤ í•¸ë“¤ëŸ¬ í˜•íƒœ

[[https://docs.aws.amazon.com/lambda/latest/dg/golang-handler.html#golang-handler-structs][Reference]]

    func () 

    func () error 

    func (TIn) error 

    func () (TOut, error) 

    func (context.Context) error 

    func (context.Context, TIn) error 

    func (context.Context) (TOut, error) 

    func (context.Context, TIn) (TOut, error)

    func (context.Context, []byte) ([]byte, error)

* ì½”ë“œ ì˜ˆì œ

    package main

    import (
        "context"
        "encoding/json"
        "github.com/aws/aws-lambda-go/lambda"
    )

    var _ lambda.Handler = (*handler)(nil)

    type handler struct{}

    func (*handler) Invoke(_ context.Context, _ []byte) ([]byte, error) {
        return json.Marshal("hello world")
    }

    func main() {
        lambda.Start(&handler{})
    }

* ë°°í¬ ë°©ë²•

[[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/golang-package.html#golang-package-mac-linux][Reference]]

    GOOS=linux CGO_ENABLED=0 GOARCH=amd64 go build -o main main.go

    zip function.zip main

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_1.png 214 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_2.png 177 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_3.png 443 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_4.png 422 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_5.png 542 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_6.png 98 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_7.png 500 780

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_8.png 149 980

* ë°°í¬ ë°©ë²•

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/go_lambda_deploy_9.png 500 876

* Golang API Gateway + Lambda ì‹¤ìŠµ

* ì½”ë“œ ì˜ˆì œ

    func (*handler) Invoke(_ context.Context, payload []byte) ([]byte, error) {
        var req events.APIGatewayV2HTTPRequest
        err := json.Unmarshal(payload, &req)
        if err != nil {
            return nil, err
        }

        resp := events.APIGatewayV2HTTPResponse{
            StatusCode: http.StatusOK,
            Headers: map[string]string{
                "Content-Type": "application/json",
            },
            MultiValueHeaders: nil,
            Body:              `{"hello": "world"}`,
            IsBase64Encoded:   false,
            Cookies:           nil,
        }
        return json.Marshal(resp)
    }

    func main() {
        lambda.Start(&handler{})
    }

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_1.png 221 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_2.png 471 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_3.png 374 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_4.png 500 220

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_5.png 500 924

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_6.png 332 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_7.png 450 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_8.png 261 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_9.png 500 931

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_10.png 398 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_11.png 156 980

* API Gateway ì‹¤ìŠµ

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/apigw_setup_12.png 278 980

* Golang API Gateway + Lambda ë¼ìš°íŒ…, ë¬¸ì œì  íŒŒì•…, ë¬¸ì œ í•´ê²° ì—¬ì •

* ì½”ë“œ ì˜ˆì œ (ê¸°ë°˜)

    func (*handler) Invoke(_ context.Context, payload []byte) ([]byte, error) {
        var req events.APIGatewayV2HTTPRequest
        err := json.Unmarshal(payload, &req)
        if err != nil {
            return nil, err
        }
        var resp events.APIGatewayV2HTTPResponse

        // route code

        return json.Marshal(resp)
    }

* ì½”ë“œ ì˜ˆì œ (route code) - 1

    switch req.RawPath {
    case "/":
        switch req.RequestContext.HTTP.Method {
        case http.MethodGet:
            resp = helloworld()
        default:
            resp = methodNotAllowed()
        }
    case "/item":
        switch req.RequestContext.HTTP.Method {
        case http.MethodGet:
            resp = item()
        default:
            resp = methodNotAllowed()
        }
    ...

* ì½”ë“œ ì˜ˆì œ (route code) - 2

    ...
    //case "/etc":
    //	switch req.RequestContext.HTTP.Method {
    //	case http.MethodPost:
    //		//... code ...
    //	default:
    //		resp = methodNotAllowed()
    //	}
    // ... code ...
    default:
        resp = notfound()
    }

* ë²Œì¨ í™”ë‚¨

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/gaviscon_before.jpg

* ì¼ë°˜ì ì¸ ê³  ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ (net/http)

    package main

    import "net/http"

    func main() {
        m := http.NewServeMux()
        m.HandleFunc("/", func(writer http.ResponseWriter, request *http.Request) {
            writer.WriteHeader(http.StatusOK)
            writer.Header().Set("Content-Type", "application/json")
            writer.Write([]byte(`{"hello": "world"}`))
        })
        m.HandleFunc("/item", func(writer http.ResponseWriter, request *http.Request) {
            writer.WriteHeader(http.StatusOK)
            writer.Header().Set("Content-Type", "application/json")
            writer.Write([]byte(`{"id": 1, "name": "My Item"}`))
        })
        http.ListenAndServe(":3000", m)
    }

* ì¼ë°˜ì ì¸ ê³  ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ (Echo Framework)

    package main

    import (
        "github.com/labstack/echo/v4"
        "net/http"
    )

    func main() {
        e := echo.New()
        e.GET("/", func(c echo.Context) error {
            return c.JSON(http.StatusOK, echo.Map{
                "hello": "world",
            })
        })
        e.GET("/item", func(c echo.Context) error {
            return c.JSON(http.StatusOK, echo.Map{
                "id":   1,
                "name": "My Item",
            })
        })
        e.Logger.Fatal(e.Start(":1323"))
    }

* ë°œí‘œ ì£¼ì œ ë¦¬ë§ˆì¸ë“œ
ê³ ì–¸ì–´ë¡œ API Gateway + Lambda ì‰½ê²Œ ì“°ê¸°
.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/ë¬¼ìŒí‘œ_ë°ˆ.jpg

* ì‰¬...ì‰½ë‚˜?

* Thank you
-

* í•©ì¹˜ë©´ ë˜ëŠ”ê±° ì•„ë‹Œê°€?

.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/ppap.jpg

* Framework ë¥¼ ë§Œë“¤ì–´ë³´ì
- Echo Framework ê¸°ëŠ¥ì„ í¬íŒ…í•´ë³´ì
- ëŒë‹¤ í™˜ê²½ì´ ì•„ë‹ˆì—¬ë„ ì‹¤í–‰ì´ ê°€ëŠ¥í•´ì•¼í•¨
- ëŒë‹¤ í™˜ê²½, ë¹„ ëŒë‹¤ í™˜ê²½ ë™ì‘ì´ ë™ì¼í•´ì•¼í•¨

* Golam
[[https://github.com/unsafe-risk/golam][Golam (ì•„ì¹´ì´ë¸Œ ì˜ˆì •)]]

* Golam Example

    package main

    import (
        "github.com/unsafe-risk/golam"
        "net/http"
    )

    type Json map[string]interface{}

    func main() {
        g := golam.New()
        g.GET("/", func(c golam.Context) error {
            return c.JSON(http.StatusOK, Json{
                "hello": "world",
            })
        })
        g.GET("/{param+}", func(c golam.Context) error {
            return c.JSON(http.StatusOK, Json{
                "hello": c.PathParams()["param"],
            })
        })
        g.StartWithLocalAddr(":3000")
    }

* ì•„ì¹´ì´ë¸Œ ì´ìœ 
- ë§Œë“¤ë‹¤ ë³´ë‹ˆ í˜ë“¤ë‹¤...
- ê¸°ëŠ¥ ì–¸ì œ ë‹¤ í¬íŒ…í•˜ëƒ...
- ê¸°ëŠ¥ ì¶”ê°€ í•˜ê¸° ê·€ì°®ì•„ì¡Œë‹¤...
- í˜¼ìí•˜ë‹ˆê¹Œ í˜ë“¤ë‹¤...

* ì•„ì¹´ì´ë¸Œ ì´ìœ  ê²°ë¡ 
.image ë§ˆë¥¸ìˆ˜ê±´ì§œê¸°/ë¸”ë£¨ë½_ì‹œì‹œí•´ì„œì£½ê³ ì‹¶ì–´ì¡Œë‹¤.jpg

* ëŒ€ì²´ì œ
- [[https://github.com/aws-serverless-go/httplam][*httplam*]]
- [[https://github.com/aws-serverless-go/echolam][*echolam*]]

* httplam, echolam ì†Œê°œ

* httplam
- net/http ê¸°ë°˜ ê³  ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ ê°€ëŠ¥
- ê³  í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸í™˜ì„±
- ëŒë‹¤ í™˜ê²½ì´ ì•„ë‹ˆì—¬ë„ ì‹¤í–‰ì´ ê°€ëŠ¥í•´ì•¼í•¨
- ëŒë‹¤ í™˜ê²½, ë¹„ ëŒë‹¤ í™˜ê²½ ë™ì‘ì´ ë™ì¼í•´ì•¼í•¨

* echolam
- Echo Framework ê¸°ë°˜ ê³  ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ ê°€ëŠ¥
- HTTP API ê°œë°œì— ìˆì–´ Echo Framework ê¸°ëŠ¥ë“¤ì„ ëŒ€ë¶€ë¶„ ì‚¬ìš© ê°€ëŠ¥í•´ì•¼í•¨
- ëŒë‹¤ í™˜ê²½ì´ ì•„ë‹ˆì—¬ë„ ì‹¤í–‰ì´ ê°€ëŠ¥í•´ì•¼í•¨
- ëŒë‹¤ í™˜ê²½, ë¹„ ëŒë‹¤ í™˜ê²½ ë™ì‘ì´ ë™ì¼í•´ì•¼í•¨

* httplam ì½”ë“œ ì˜ˆì œ
    package main

    import (
        "github.com/aws-serverless-go/httplam"
        "net/http"
    )

    func main() {
        m := http.NewServeMux()
        m.HandleFunc("/", func(writer http.ResponseWriter, request *http.Request) {
            writer.WriteHeader(http.StatusOK)
            writer.Header().Set("Content-Type", "application/json")
            writer.Write([]byte(`{"hello": "world"}`))
        })
        if httplam.IsLambdaRuntime() {
            httplam.StartLambdaWithAPIGateway(m)
        } else {
            http.ListenAndServe(":3000", m)
        }
    }

* echolam ì½”ë“œ ì˜ˆì œ
    package main

    import (
    	"github.com/aws-serverless-go/echolam"
    	"github.com/aws-serverless-go/httplam"
    	"github.com/labstack/echo/v4"
    	"net/http"
    )

    func main() {
    	e := echo.New()
    	e.GET("/", func(c echo.Context) error {
    		return c.JSON(http.StatusOK, echo.Map{
    			"hello": "world",
    		})
    	})
    	if httplam.IsLambdaRuntime() {
    		echolam.StartLambdaWithAPIGateway(e)
    	} else {
    		e.Logger.Fatal(e.Start(":1323"))
    	}
    }

* ì‹¤ìŠµ

* ì•„ì‰¬ìš´ ì 
- cli ë¶€ì¬
- API Gateway ì†ìœ¼ë¡œ ë¼ìš°íŒ… ê±¸ì–´ì¤˜ì•¼í•¨
- Lambda ì†ìœ¼ë¡œ ë°°í¬ í•´ì¤˜ì•¼í•¨ -> CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì„±ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•˜ê¸´í•¨
- Response ë¶€ë¶„ì—ì„œ continuous buffer ì´ë‹¤ ë³´ë‹ˆ bufferì˜ capacity ì‚¬ì´ì¦ˆë¥¼ ë„˜ì–´ê°€ëŠ” ìˆœê°„ ìƒˆë¡œìš´ slice ìƒì„± ë° ê°’ ë³µì‚¬ì— ëŒ€í•œ ì˜¤ë²„í—¤ë“œ, non-continuous bufferë¡œ ëŒ€ì²´ í•„ìš”
ê¸°ì—¬ ë¬¸ì˜ëŠ” DM ìœ¼ë¡œ ë¶€íƒë“œë ¤ìš”~ğŸ™
ë†ë‹´ì´ê³  ëˆ„êµ¬ë“  ê¸°ì—¬ë¥¼ í™˜ì˜í•©ë‹ˆë‹¤.
[[https://github.com/orgs/aws-serverless-go/repositories][Link]]

* í•œê³„
- ëª¨ë“  ëŒë‹¤ì˜ í•œê³„ì 
- ëª¨ë“  API Gatewayì˜ í•œê³„ì 
- ëŠë¦¬ë‹¤..

[[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/gettingstarted-limits.html][Lambda quotas]]
[[https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/limits.html#http-api-quotas][API Gateway quotas]]